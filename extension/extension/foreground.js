var phrases = {
  "air ball":
    "A shot that doesn’t connect with either the rim or the backboard. When an attempt doesn’t hit any part of the basket, the shot clock does not reset.",
  "alley oop":
    "An offensive play in which the ball handler passes the ball towards the basket to a teammate who is already in the air, who then catches the ball and dunks or lays the ball up, all in one motion without landing first.",
  "and one":
    "When a player is fouled during the act of shooting but makes the basket regardless, the shot counts, and they are awarded one additional shot.",
  "backcourt violation":
    "Once the ball has passed the half-court line, the offense cannot cross back into their backcourt again without the defense first touching the ball and knocking it out of the offense’s possession. If an offensive player does pass back into the backcourt after crossing, a violation is called, and the defending team receives possession of the ball.",
  "ball fake":
    "When the offensive player fakes a pass or shot while holding the basketball.",
  bank: "A shot that first hits the backboard before going through the rim. The square on the backboard helps players aim bank shots from angles other than straight ahead.",
  "big man":
    "A basketball player who is typically larger in stature and plays either the power forward or center position. These athletes usually play on the post, near the paint, and are responsible for scoring close to the basket, blocking shots, and getting rebounds.",
  "box out":
    "The technique in which athletes position themselves between the basket and their opponents when a shot attempt goes up, with the intention of getting better position for the rebound if the effort is missed.",
  brick:
    "When a shot attempt hits the rim or backboard and bounces off without going in the basket.",
  "buzzer beater":
    "A shot that’s attempted in the final seconds of a period of play, usually taken mere moments before the time expires, resulting in the buzzer sounding just as the ball travels through the hoop or misses.",
  center:
    "The position in basketball that’s traditionally meant for the largest player on the court. These athletes are usually tasked with guarding the paint, getting rebounds, and blocking shots in the front court.",
  charge:
    "A foul committed by the offense, usually when a player with the ball runs over a defender who has already established position and set their feet.",
  cut: "An action made by offensive players in which they quickly accelerate in a different direction, usually towards the basket in the hope of catching the defense off guard and scoring an easy basket.",
  "defensive rebound":
    "When an offensive player shoots and misses, and the missed shot is retrieved by the team playing defense.",
  dish: "A slang term for a pass from one offensive player to another. Usually used when the pass results in an assist.",
  "double double":
    "A slang term for a pass from one offensive player to another. Usually used when the pass results in an assist.",
  "double dribble":
    "A penalty that occurs when an offensive player dribbles, picks up their dribble, then dribbles again or dribbles the ball with both hands simultaneously. This results in the offending team losing possession of the ball and receiving a turnover on the stat sheet.",
  "double team":
    "When two defensive teammates guard a single offensive player at the same time.",
  drive:
    "When the ballhandler advances towards the basket, frequently with the intention of either dunking or making a layup. Currently, a player driving towards the basket will also look to pass the ball to an open man beyond the three-point line as well.",
  dunk: "An offensive action in which a shot is made by delivering the ball straight into the rim without releasing a shot.",
  elbow:
    "The corner where the key meets the ends of the free-throw line. This is a common area from which to shoot two-point field goals or set screens.",
  "entry pass":
    "A pass made to inbound the ball from out of bounds or to initiate the offense, usually made from the perimeter into the post or wing.",
  "euro step":
    "An offensive maneuver executed by a ballhandler driving to the basket. The player uses their two steps to jump first to their left, then drastically to their right, or vice versa in an effort to get around the defending player without making contact and lay the ball up. The move was popularized by Manu Ginobili in the NBA and is now associated with James Harden as one of his signature moves.",
  fadeaway:
    "A jump shot taken while falling or jumping backward or to the side. The ball is released while the player is in motion. While these are often more difficult to make, they are also harder for the defender to block.",
  "fast break":
    "An offensive play in which a team swiftly advances the ball towards the hoop after obtaining possession, usually after a steal or long rebound, meant to score quickly before the defense is set.",
  "field goal":
    "A shot made while the ball is in play. This means baskets other than free throws.",
  "finger roll":
    "A specific type of layup in which the shooter delivers the ball into the basket in a fluid underhanded motion in which they extend the arm with the ball towards the hoop and allow the ball to roll from the hand, over the fingers, and into the basket.",
  "five second violation":
    "A violation called when a team inbounding the ball takes longer than five seconds to put the ball into play. This results in a change of possession and a turnover.",
  forward:
    "Two of the five starting positions. These players are traditionally larger than the guards and smaller than the center. They play on the wings or closer to the basket in most offenses, although the current NBA game demands forwards to be able to shoot from long range to be effective.",
  flagrant:
    "A foul that’s overly aggressive and physical and considered outside the play of the game. It’s when a player makes illegal contact with the opposition in a manner that’s not considered an attempt at obtaining the ball and is instead excessive and possibly done with the intent to hurt or injure.",
  floater:
    "A style of shooting the ball in the lane or while driving to the basket. This technique is usually utilized by guards trying to score over a bigger player. The ball is released with one hand while the ballhandler is on the move, with high arc meant to go over the block attempts and fall into the hoop.",
  flop: "An overreaction or exaggerated movement done with the intention of drawing a foul on the other team that may or may not be deserved.",
  foul: "Illegal contact made with the opposition on either side of the ball. This can include hitting a shooter on the arm, running over a defender, or grabbing a dribbling opponent. When the offensive player is in the act of shooting, foul shots are rewarded.",
  "four point play":
    "A relatively rare play in which an offensive player in the act of shooting a three-pointer is fouled in the action but makes the shot regardless. This gives them one additional free throw after counting the three points. If the free throw is made, the team earns four points on a single possession.",
  "free throw":
    "An unguarded shot attempt worth one point, taken from the free throw line, fifteen feet in front of the basket.",
  goaltend:
    "Stopping a shot that’s either in the basket or traveling down towards the rim after already hitting its apex. Defensive goaltending results in the offense receiving an automatic two points, while offensive goaltending is a turnover.",
  guard:
    "A term used to describe defending a player. Also the title of the two backcourt players, usually smaller in stature, responsible for dribbling the ball up the court, setting up the offense, passing, and shooting from range.",
  "high post":
    "The area near the paint but closer to the free throw line or elbow than the block.",
  "hook shot":
    "A one-handed overhead shot typically taken in the post. The shooter is situated with their side to the basket, and the arm farthest from the basket is used to release the ball in a hooking motion high above the head, making the shot tricky to block. This technique was made famous by Kareem Abdul-Jabbar and was mostly unblockable.",
  inbounds:
    "The act of throwing the ball into play from beyond the baseline or sidelines after a dead ball.",
  iso: "An offensive strategy in which the offense spreads out along the perimeter and allows the ballhandler to attack the defending player one on one, either by driving by them towards the hoop or by setting up a shot from distance without the need for passing or screens. Usually utilized when the offense has a mismatch along the perimeter, such as a center trying to defend a guard.",
  jab: "A quick, sharp, step with the non-pivot foot meant to fake the ballhandler taking off in that direction to keep them on their heels and create space for either driving or pulling up for a shot.",
  "jump ball":
    "When the ball is tossed into the air by the referee while one player from each team jumps and tries to tip the ball at its apex towards their players. This is also a call made when two opposing players grab the ball, and neither can wrestle away possession in time.",
  key: "Another name for the paint or the lane, usually painted another color than the surrounding area within the perimeter.",
  lane: "Another name for the “paint” or “key.” The area runs from the baseline under the basket to the free throw line and from block to block.",
  "lay up":
    "A close-range shot usually made in one fluid motion with one hand while a player drives towards the hoop.",
  "low post":
    "The area near the basket, on either side of the hoop inside or just outside of the lane, usually on the blocks.",
  "off the dribble":
    "Pulling up for a jump shot immediately upon gathering the dribble in one fluid motion.",
  "offensive rebound":
    "A missed shot that’s obtained by an offensive player, giving them another attempt to score on that possession.",
  "offensive foul":
    "A foul committed by a player on offense, usually for charging over a defender that’s already set in position.",
  "out of bounds":
    "The area beyond the boundaries of play. When the ball goes out of bounds or touches the baseline or sidelines, the team who touched it last is considered responsible, and possession is awarded to the other side.",
  overtime:
    "When the four regulation quarters end in a tie, an extra period is added. This will continue until one team finishes the time of play with more points.",
  paint:
    "The painted area that runs from the baseline to the free throw line, including the space between the two blocks. Also called the “lane” or the “key.”",
  "pick and roll":
    "An offensive strategy in which a player sets a screen for the man with the ball, then streaks to the basket immediately after setting the pick, expecting a pass for an easy layup.",
  "points in the paint":
    "The number of points scored from field goals attempted within the lane.",
  "post up":
    "A way of positioning oneself down near the basket by turning away from the hoop and sealing off the defender to easily catch an entry pass into the post.",
  rainbow: "A shot, usually from long range, with a high arc.",
  rebound:
    "A measured statistic in which a player from either team obtains possession following a missed shot attempt that hits either the backboard or rim.",
  screen:
    "An action on offense when a teammate without the ball stands next to the defender guarding the ballhandler meant to impede the defender’s progress, while the player with the ball runs past the screener. This allows the player with the ball to get open for a shot or drive through the lane.",
  "shot clock":
    "A timer that begins counting down at the beginning of every possession. In the NBA, teams have 24 seconds to take a shot and hit the rim; otherwise, they receive a violation and turnover. If the ball does hit the rim, the shot clock starts over.",
  shooter:
    "The offensive player with possession of the ball who attempts to score by throwing the ball into the basket.",
  "sixth man":
    "A member of the roster that doesn’t start but is usually the first substitute off the bench. These players are generally volume scorers.",
  spacing:
    "The amount of open floor between offensive players, making room for drives and passing the ball around.",
  splash:
    "Another word for a swish. A slang term describing a made shot that doesn’t hit the backboard or rim while going in.",
  switch:
    "When defensive players change assignments following a pick set by the offense. This is a faster way to recover than chasing one’s original man around the screen.",
  "team foul":
    "The number of fouls an entire team has committed. These lead to bonus situations if too many are accrued.",
  technical:
    "A foul called as a result of some tertiary infraction like cursing at an official or shoving an opposing player during a dead ball.",
  "three point play":
    "When an offensive player is fouled during the act of shooting a two-point shot or layup but makes it anyway. They then receive a free throw and the opportunity to score three points total on the single play.",
  "tip off": "The opening jump ball that begins every basketball game.",
  "top of the key":
    "The arc area above the free-throw line but inside of the three-point line.",
  travel:
    "A moving violation in which a player takes too many steps without dribbling, jumps into the air, and lands without getting rid of the ball, or moves their pivot foot. This results in a change of possession and turnover.",
  "triple double":
    "When a player records totals of ten or more in three different statistical categories.",
  turnover:
    "When the offensive team gives up the ball without getting off a shot. Turnovers can come from steals, going out of bounds, or other violations.",
  wing: "1. An area located on either side of the court, beyond the three-point line, lined up with the free-throw line. 2. A term used to describe a player that plays in the area defined as the wing. These are usually shooting guards and small forwards.",
  "zone defense":
    "A defensive strategy involving players guarding specific zones and areas rather than a specific offensive player.",
};

// Make first letter of each word uppercase
function makeUppercase(phrase) {
  return phrase
    .split(" ")
    .map((s) => s.charAt(0).toUpperCase() + s.substring(1))
    .join(" ");
}

// Determine which MutationRecord has the actual changes I care about
function getAddedNode(mutations) {
  if (mutations.length == 0) {
    return null;
  }

  var addedNode = null;
  for (var i = mutations.length - 1; i >= 0; i--) {
    if (mutations[i].addedNodes.length == 1) {
      addedNode = mutations[i].addedNodes.item(0);
      break;
    } else if (mutations[i].addedNodes.length > 1) {
      console.log("wtf more than one added node");
    }
  }
  return addedNode;
}

// Create the window composed of the previous and current segments of captions
function createWindow(prev, curr) {
  var crossSize = 10;
  if (curr.length < crossSize) {
    crossSize = curr.length;
  }

  var prevCrossIndex = prev.lastIndexOf(curr.substring(0, crossSize));
  if (prevCrossIndex == -1) {
    return prev + " " + curr;
  }
  return prev.substring(0, prevCrossIndex - 1) + " " + curr;
}

var prevCaptions = null;
var moreInfo = " (click for more info!)";
var timers = {};

// Allow time for the video player to initialize
setTimeout(function () {
  MutationObserver = window.MutationObserver || window.WebKitMutationObserver;

  var observer = new MutationObserver(function (mutations, _observer) {
    // console.log(mutations);

    var addedNode = getAddedNode(mutations);
    if (addedNode == null) {
      return;
    }

    var caption = addedNode.innerText;

    caption = caption.split(/\s+/);
    caption = caption.map((word) =>
      word.toLowerCase().replace(/[.,!?\\-]/, " ")
    );
    caption = caption.join(" ");

    if (prevCaptions == null) {
      prevCaptions = caption;
      return;
    }

    if (caption == prevCaptions) {
      return;
    }

    var window = createWindow(prevCaptions, caption);
    // console.log("window: ", window);

    prevCaptions = caption;

    var matches = [];
    for (var phrase in phrases) {
      // check if there's a space after phrase or it's the end of the window
      //  or if there's a space before phrase or it's the beginning of the window
      var index = window.search(phrase);
      if (
        index !== -1 &&
        (index + phrase.length == window.length ||
          window[index + phrase.length] == " ") &&
        (index == 0 || window[index - 1] == " ") &&
        !matches.includes(phrase)
      )
        matches.push(phrase);
    }

    // console.log("matches: ", matches);

    // Send message to background.js for each matched phrase
    if (matches.length > 0) {
      for (var match of matches) {
        if (!(match in timers) || Date.now() - timers[match] > 30000) {
          timers[match] = Date.now();
        } else {
          console.log(`SKIPPING - sent ${match} notif in the last 30 seconds`);
          continue;
        }
        chrome.runtime.sendMessage("", {
          type: "notification",
          options: {
            title: makeUppercase(match) + moreInfo,
            message: phrases[match],
            iconUrl: "images/logo.png",
            type: "basic",
          },
        });
      }
    }
  });

  var updated = document.body.getElementsByClassName(
    "vjs-text-track-display"
  )[0];

  // console.log(updated);

  // Define what element should be observed by the observer and what types of mutations trigger the callback
  observer.observe(updated, {
    subtree: true,
    childList: true,
  });
}, 5000);
